import { database } from '@bahasa-ai/engine-database'
import * as Bull from 'bull'
import { F1ChatbotSessionNotifierPush } from '../../Bot/CSAT/F1SessionNotifier/Main'
import { HumanAgentBullType } from './../../Type/HumanAgentBull'

export async function ChatbotNotifier(job: Bull.Job<HumanAgentBullType.ChatbotNotifier>, done: () => void) {
  if (!job.data) {
    return done()
  }

  const users = await database().User.get({
    sourceId: { $eq: job.data.sourceId },
    integration: { $eq: job.data.integration },
    agentId: { $eq: job.data.agentId }
  })
  if (!users.length) {
    return done()
  }

  await new F1ChatbotSessionNotifierPush().pushWithoutEvent({
    agentId: job.data.agentId,
    intentSlug: 'F1ChatbotSessionNotifierPush',
    sourceId: job.data.sourceId,
    integration: job.data.integration as any,
  }, users[0].userData.name)

  return done()
}